<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reports Dashboard TEST</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
  <!-- LOGIN SCREEN -->
  <div id="loginSection">
    <h2>Login</h2>
    <div id="g_id_onload"
        data-client_id="634726700514-e1mk0mlff6lacdrs6f7a6shvlj9th6d3.apps.googleusercontent.com"
        data-callback="onGoogleLogin">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <!-- NO ACCESS YET SCREEN -->
  <div id="noAccessSection" style="display:none;">
    <h2>Account pending access</h2>
    <p>Your account is created, but not linked to any company yet.</p>
    <p>Please contact the admin to link you, then refresh and log in again.</p>
  </div>

  <!-- APP SCREEN -->
  <div id="appSection" style="display:none;">

    <button id="openChatBtn">Q&A Assistant</button>

    <h2>Talking products</h2>
    <select id="products"></select>

    <h2>Report type</h2>
    <select id="reportType">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="aggregated">Aggregated</option>
    </select>

    <h2>Date</h2>
    <input type="date" id="reportDate">
    <!-- <button onclick="loadReport()">Load report</button> -->

    <h2>Report</h2>
    <div id="report"></div>
  </div>

  <div id="chatSection" style="display:none; max-width:800px; margin:0 auto;">
    <button id="backToReportsBtn">← Back to reports</button>
    <h2>Q&A Assistant</h2>

    <div id="chatWindow" style="
        border:1px solid #ddd;
        height:400px;
        overflow-y:auto;
        padding:8px;
        border-radius:8px;
        background:#fafafa;
        margin-bottom:8px;"></div>

    <div id="chatInputRow" style="display:flex; gap:8px;">
      <input id="chatInput" type="text" placeholder="Ask a question about your reports..."
            style="flex:1; padding:8px; border-radius:8px; border:1px solid #ccc;">
      <button id="sendChatBtn">Send</button>
    </div>
  </div>


<script>

  function renderReport(report) {
    const container = document.getElementById("report");
    container.innerHTML = "";

    // THEMES / TOPICS
    const themesHtml = report.topics.map(t => `
      <div style="border:1px solid #ddd;padding:16px;border-radius:12px;margin-bottom:12px;">
        <h3>✔ ${t.topic}</h3>

        <h4>Observation</h4>
        <p>${t.observation}</p>

        <h4>Implication</h4>
        <p>${t.implication}</p>

        <h4>Strategic Alignment</h4>
        <p><strong>${t.strategic_alignment.objective}</strong> — ${t.strategic_alignment.status}</p>

        <h4>Recommendation</h4>
        <p><strong>Priority:</strong> ${t.recommendation.priority}</p>
        <p><strong>Action:</strong> ${t.recommendation.action}</p>
        <p><strong>Alternative:</strong> ${t.recommendation.alternative || "—"}</p>
        <p><strong>Impact:</strong> ${t.recommendation.impact}</p>

        <h4>Decision Required</h4>
        <p>${t.decision_required}</p>
      </div>
    `).join("");

    // EXECUTIVE SUMMARY
    const summaryHtml = report.executive_summary.map(s => `
      <div style="border:1px solid #ddd;padding:16px;border-radius:12px;margin-bottom:12px;">
        <h4>Objective</h4>
        <p>${s.objective}</p>
        <h4>Status</h4>
        <p>${s.status}</p>
        <h4>Key Decision Needed</h4>
        <p>${s.key_decision_needed}</p>
      </div>
    `).join("");

    container.innerHTML = `
      <h2>Themes</h2>
      ${themesHtml}

      <h2>Executive Summary</h2>
      ${summaryHtml}

      <h2>Overall Takeaway</h2>
      <div style="background:#eef3ff;padding:16px;border-radius:12px;">
        ${report.overall_takeaway}
      </div>
    `;
  }
</script>

  <script>
    let token = null;
    const API_BASE = "http://127.0.0.1:8000";
    let messages = []; // {role: "user"|"assistant", content: string, citations?: array}

    function showLogin() {
      document.getElementById("loginSection").style.display = "block";
      document.getElementById("noAccessSection").style.display = "none";
      document.getElementById("appSection").style.display = "none";
      document.getElementById("chatSection").style.display = "none";
    }

    function showNoAccess() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("noAccessSection").style.display = "block";
      document.getElementById("appSection").style.display = "none";
      document.getElementById("chatSection").style.display = "none";
    }

    function showApp() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("noAccessSection").style.display = "none";
      document.getElementById("appSection").style.display = "block";
      document.getElementById("chatSection").style.display = "none";
    }

    function showChat() {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("noAccessSection").style.display = "none";
      document.getElementById("appSection").style.display = "none";
      document.getElementById("chatSection").style.display = "block";
    }

    async function api(path, options = {}) {
      const res = await fetch(API_BASE + path, {
        ...options,
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
          ...(options.headers || {})
        }
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        throw { status: res.status, data };
      }
      return data;
    }

    async function onGoogleLogin(response) {
      token = response.credential;

      try {
        const products = await api("/me/talking-products");
        populateProducts(products);

        // defaults
        document.getElementById("reportType").value = "daily";
        showApp();

        // auto-load latest report for first product (if any)
        if (products.length > 0) {
          try {
            await loadLatestReport();
          } catch (err) {
            // If we get here, it's NOT a simple 404 (that’s already handled inside loadLatestReport)
            console.log("Error loading latest report on login:", err);
            document.getElementById("report").innerHTML =
              "<p>Could not load latest report. Please pick another date/type.</p>";
          }
        }
      } catch (err) {
        console.log("Login/backend error:", err);

        if (err.status === 403 && String(err.data?.detail || "").includes("User not linked")) {
          showNoAccess();
        } else {
          alert("Unexpected login error. Check the console.");
          showLogin();
        }
      }
    }



    function populateProducts(products) {
      const select = document.getElementById("products");
      select.innerHTML = "";
      products.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
    }

    async function loadReport() {
      const tp = document.getElementById("products").value;
      const type = document.getElementById("reportType").value;
      const date = document.getElementById("reportDate").value;

      let url = `/reports?report_type=${type}&report_date=${date}`;
      if (type !== "aggregated") {
        url += `&talking_product_id=${tp}`;
      }

      const data = await api(url);
      renderReport(data.report);
    }

    async function loadLatestReport() {
      const tp = document.getElementById("products").value;
      const type = document.getElementById("reportType").value;

      let url = `/reports/latest?report_type=${type}`;
      if (type !== "aggregated") {
        url += `&talking_product_id=${tp}`;
      }

      try {
        const data = await api(url);

        // data.date is e.g. "2025-01-05"
        document.getElementById("reportDate").value = data.date;

        // render report
        renderReport(data.report);
      } catch (err) {
        console.log("loadLatestReport error:", err);

        // If there is simply no report yet, don't treat it as a login failure
        if (err.status === 404) {
          document.getElementById("reportDate").value = "";
          document.getElementById("report").innerHTML =
            "<p>No reports found for this selection.</p>";
          return;
        }

        // For other errors, rethrow so caller can decide
        throw err;
      }
    }

    async function sendChat() {
      const inputEl = document.getElementById("chatInput");
      const text = inputEl.value.trim();
      if (!text) return;

      inputEl.value = "";

      // Use currently selected talking product if any
      const tp = document.getElementById("products").value || null;

      // Add user message
      messages.push({ role: "user", content: text });
      renderChat();

      try {
        const data = await api("/ask", {
          method: "POST",
          body: JSON.stringify({
            question: text,
            talking_product_id: tp || null
          })
        });

        messages.push({
          role: "assistant",
          content: data.answer,
          citations: data.citations || []
        });
        renderChat();
      } catch (err) {
        console.log("Error calling /ask:", err);
        messages.push({
          role: "assistant",
          content: "There was an error calling the assistant. Please try again."
        });
        renderChat();
      }
    }

    function renderChat() {
      const chatWindow = document.getElementById("chatWindow");
      chatWindow.innerHTML = "";

      messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = "msg " + msg.role;
        div.style.margin = "8px 0";
        div.style.padding = "8px 12px";
        div.style.borderRadius = "12px";
        div.style.maxWidth = "70%";

        if (msg.role === "user") {
          div.style.background = "#e0f7ff";
          div.style.marginLeft = "auto";
        } else {
          div.style.background = "#f1f1f1";
          div.style.marginRight = "auto";
        }

        const p = document.createElement("p");
        p.textContent = msg.content;
        div.appendChild(p);

        if (msg.citations && msg.citations.length) {
          const small = document.createElement("small");
          small.textContent = "Sources: " + msg.citations.join(", ");
          div.appendChild(small);
        }

        chatWindow.appendChild(div);
      });

      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Change talking product → latest report for that product & current type
    document.getElementById("products").addEventListener("change", () => {
      loadLatestReport();
    });

    // Change report type → latest report for that type & current product
    document.getElementById("reportType").addEventListener("change", () => {
      loadLatestReport();
    });

    // Change date → load report for that date
    document.getElementById("reportDate").addEventListener("change", () => {
      loadReport();
    });

    document.getElementById("openChatBtn").addEventListener("click", () => {
      showChat();
    });

    document.getElementById("backToReportsBtn").addEventListener("click", () => {
      showApp();
    });

    document.getElementById("sendChatBtn").addEventListener("click", () => {
      sendChat();
    });

    document.getElementById("chatInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });

    showLogin();
  </script>
</body>