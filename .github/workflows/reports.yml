name: Daily Automatic Reporting

on:
  # schedule:
    # - cron: "59 23 * * *"    # run daily at 23:59 UTC
  workflow_dispatch: {}       # allow manual trigger

jobs:
  run-daily:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore Gmail credential files
        shell: bash
        run: |
          echo "${{ secrets.GMAIL_CLIENT_SECRET_B64 }}" | base64 -d > client_secret.json
          echo "${{ secrets.GMAIL_TOKEN_B64 }}" | base64 -d > gmail_token.json

      - name: Run main.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CHROMA_KEY: ${{ secrets.CHROMA_KEY }}
          CHROMA_TENANT: ${{ secrets.CHROMA_TENANT }}
          CHROMA_DATABASE: "Test"
          CHROMA_COLLECTION_NAME: "interactions"
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          SUBJECT_PATTERN: "jarno"
          SENDER_PATTERN: "mail@i.no-reply-messages.com"
          REPORT_STRUCTURE_PATH: "prompt_input/report_structure.json"
          CONTEXT_PATH: "prompt_input/context.md"
          DAILY_PROMPT_TEMPLATE_PATH: "prompt_input/prompt_template.md"
          MODEL: "models/gemini-2.5-flash"
          CONTEXT_WINDOW: 1000000
          TOKEN_ENCODING_MODEL: "cl100k_base"
          MIN_TOKENS_PER_CLUSTER: 200
          SENTENCE_EMBEDDING_MODEL: "intfloat/multilingual-e5-base"
        run: python main.py
